# Тест-кейсы для платёжной системы OrchestrPay

## Таблица тест-кейсов

| № | Название | Тип | Компоненты | Предусловия | Шаги теста | Ожидаемый результат |
|---|----------|-----|------------|-------------|------------|---------------------|
| **1. End-to-End тесты основных сценариев** |
| 1.1 | Успешная обработка платежа (Happy Path) | E2E | Payment Service, FraudCheck Service, Notification Service | - Клиент имеет достаточно средств<br>- FraudCheck сервис доступен<br>- Notification сервис доступен | 1. Инициировать платёж<br>2. Дождаться завершения Saga | - Платёж в статусе COMPLETED_SUCCESS<br>- Средства списаны с клиента<br>- Средства переведены контрагенту<br>- Клиент получил уведомление об успехе<br>- SLA <5 секунд соблюдён |
| 1.2 | Отклонение платежа FraudCheck | E2E | Payment Service, FraudCheck Service, Notification Service | - Клиент имеет достаточно средств<br>- FraudCheck настроен на отклонение | 1. Инициировать платёж<br>2. FraudCheck возвращает DECLINED<br>3. Дождаться завершения компенсации | - Платёж в статусе COMPLETED_DECLINED<br>- Средства возвращены клиенту<br>- Контрагент НЕ получил средства<br>- Система безопасности уведомлена<br>- Клиент получил уведомление об отклонении |
| 1.3 | Ручная проверка с одобрением | E2E | Payment Service, FraudCheck Service, Notification Service | - Клиент имеет достаточно средств<br>- FraudCheck возвращает MANUAL_REVIEW | 1. Инициировать платёж<br>2. FraudCheck возвращает MANUAL_REVIEW<br>3. Оператор одобряет в течение 20 минут<br>4. Дождаться завершения | - Платёж в статусе MANUAL_REVIEW_REQUIRED<br>- После одобрения → COMPLETED_SUCCESS<br>- Средства переведены контрагенту<br>- Клиент получил уведомление |
| 1.4 | Ручная проверка с отклонением | E2E | Payment Service, FraudCheck Service, Notification Service | - Клиент имеет достаточно средств<br>- FraudCheck возвращает MANUAL_REVIEW | 1. Инициировать платёж<br>2. FraudCheck возвращает MANUAL_REVIEW<br>3. Оператор отклоняет в течение 20 минут<br>4. Дождаться компенсации | - Платёж в статусе COMPLETED_DECLINED<br>- Средства возвращены клиенту<br>- Система безопасности уведомлена<br>- Клиент получил уведомление |
| 1.5 | Cut-off time для FraudCheck (автоматическое одобрение) | E2E | Payment Service, FraudCheck Service (mock), Notification Service | - FraudCheck сервис не отвечает/медленный<br>- Cut-off time настроен | 1. Инициировать платёж<br>2. FraudCheck не отвечает<br>3. Дождаться истечения cut-off time<br>4. Дождаться завершения | - Платёж автоматически одобрен после таймаута<br>- Статус COMPLETED_SUCCESS<br>- Средства переведены контрагенту |
| 1.6 | Cut-off time для ручной проверки (автоматическое одобрение) | E2E | Payment Service, FraudCheck Service, Notification Service | - FraudCheck возвращает MANUAL_REVIEW<br>- Оператор не принимает решение 20 минут | 1. Инициировать платёж<br>2. FraudCheck возвращает MANUAL_REVIEW<br>3. Оператор не реагирует 20 минут<br>4. Дождаться автоматического одобрения | - Платёж автоматически одобрен через 20 минут<br>- Статус COMPLETED_SUCCESS<br>- Средства переведены контрагенту |
| **2. Интеграционные тесты взаимодействия с сервисами** |
| 2.1 | Создание платежа | Integration | Payment Service | - База данных доступна | 1. Отправить запрос на создание платежа<br>2. Проверить запись в БД | - Запись создана<br>- Статус CREATED<br>- Присвоен уникальный ID<br>- Timestamp зафиксирован |
| 2.2 | Резервирование средств | Integration | Payment Service | - Платёж создан<br>- Клиент имеет достаточно средств | 1. Выполнить резервирование средств<br>2. Проверить баланс клиента | - Средства заблокированы<br>- Статус FUNDS_RESERVED<br>- Доступный баланс уменьшен |
| 2.3 | Списание средств | Integration | Payment Service | - Средства зарезервированы | 1. Выполнить списание средств<br>2. Проверить транзакцию | - Средства списаны<br>- Статус FUNDS_DEBITED<br>- Транзакция записана в журнал |
| 2.4 | Запрос в FraudCheck | Integration | Payment Service, FraudCheck Service | - Платёж создан и средства списаны<br>- FraudCheck сервис доступен | 1. Отправить запрос в FraudCheck<br>2. Получить ответ | - Запрос успешно отправлен<br>- Ответ получен (APPROVED/DECLINED/MANUAL_REVIEW)<br>- Статус обновлён |
| 2.5 | Перевод средств контрагенту | Integration | Payment Service | - FraudCheck одобрил транзакцию<br>- Контрагент существует | 1. Выполнить перевод средств<br>2. Проверить баланс контрагента | - Средства зачислены контрагенту<br>- Статус COUNTERPARTY_CREDITED<br>- Pivot Point пройден |
| 2.6 | Отправка уведомления об успехе | Integration | Payment Service, Notification Service | - Платёж успешно проведён | 1. Отправить уведомление клиенту<br>2. Проверить доставку | - Уведомление отправлено<br>- Клиент получил уведомление<br>- Статус NOTIFICATION_SENT |
| 2.7 | Возврат средств клиенту | Integration | Payment Service | - Средства списаны<br>- Требуется компенсация | 1. Выполнить возврат средств<br>2. Проверить баланс клиента | - Средства возвращены на счёт<br>- Статус REFUNDED<br>- Транзакция возврата записана |
| 2.8 | Уведомление системы безопасности | Integration | Payment Service, Security System (mock) | - FraudCheck отклонил транзакцию | 1. Отправить уведомление в систему безопасности<br>2. Проверить доставку | - Уведомление доставлено<br>- Статус SECURITY_NOTIFIED<br>- Данные транзакции переданы |
| **3. Тесты компенсационных транзакций** |
| 3.1 | Компенсация: Cancel Payment после ошибки создания | Integration | Payment Service | - Ошибка при создании платежа | 1. Симулировать ошибку создания<br>2. Проверить отсутствие записи | - Платёж не создан<br>- База данных не изменена<br>- Процесс прерван |
| 3.2 | Компенсация: Cancel Payment после ошибки резервирования | Integration | Payment Service | - Платёж создан<br>- Недостаточно средств для резервирования | 1. Попытаться зарезервировать средства<br>2. Дождаться компенсации | - Платёж отменён<br>- Статус COMPLETED_CANCELLED<br>- Средства не заблокированы |
| 3.3 | Компенсация: Release Funds после ошибки списания | Integration | Payment Service | - Средства зарезервированы<br>- Ошибка при списании | 1. Симулировать ошибку списания<br>2. Проверить компенсацию | - Средства разблокированы<br>- Доступный баланс восстановлен<br>- Платёж отменён |
| 3.4 | Компенсация: Refund Customer после отклонения FraudCheck | Integration | Payment Service, FraudCheck Service | - Средства списаны<br>- FraudCheck отклонил | 1. FraudCheck возвращает DECLINED<br>2. Дождаться возврата | - Средства возвращены полностью<br>- Баланс клиента восстановлен<br>- Транзакция возврата записана |
| 3.5 | Компенсация: Полный цикл при отклонении | E2E | Payment Service, FraudCheck Service, Notification Service | - Платёж проходит все этапы<br>- FraudCheck отклоняет | 1. Создать → Зарезервировать → Списать → FraudCheck DECLINED<br>2. Дождаться полной компенсации | - Возврат выполнен<br>- Уведомление отправлено<br>- Система безопасности уведомлена<br>- Платёж отменён<br>- Статус COMPLETED_DECLINED |
| **4. Тесты Pivot Point** |
| 4.1 | Pivot Point: Успешный перевод без возможности отката | Integration | Payment Service | - FraudCheck одобрил<br>- Готов к переводу контрагенту | 1. Выполнить перевод контрагенту<br>2. Симулировать ошибку после перевода | - Средства переведены<br>- Откат НЕВОЗМОЖЕН<br>- Состояние зафиксировано |
| 4.2 | После Pivot Point: Retry уведомлений | Integration | Payment Service, Notification Service | - Pivot Point пройден<br>- Notification Service недоступен | 1. Перевод контрагенту успешен<br>2. Notification Service возвращает ошибку<br>3. Дождаться retry | - Уведомление повторяется<br>- Возврат НЕ выполняется<br>- Retry до успеха |
| 4.3 | До Pivot Point: Ошибка перевода с компенсацией | Integration | Payment Service | - FraudCheck одобрил<br>- Ошибка при переводе контрагенту (до фактического перевода) | 1. Симулировать ошибку перевода<br>2. Дождаться компенсации | - Перевод НЕ выполнен<br>- Средства возвращены клиенту<br>- Статус COMPLETED_DECLINED |
| **5. Тесты идемпотентности** |
| 5.1 | Идемпотентность: Повторное создание платежа | Integration | Payment Service | - Платёж уже создан | 1. Отправить повторный запрос с тем же ID<br>2. Проверить результат | - Дубликат не создан<br>- Возвращён существующий платёж<br>- HTTP 200 (не 201) |
| 5.2 | Идемпотентность: Повторный запрос FraudCheck | Integration | Payment Service, FraudCheck Service | - Запрос уже отправлен<br>- Результат закэширован | 1. Отправить повторный запрос<br>2. Проверить кэш | - Повторный вызов не выполнен<br>- Вернут кэшированный результат<br>- Время отклика минимальное |
| 5.3 | Идемпотентность: Повторная отправка уведомления | Integration | Payment Service, Notification Service | - Уведомление уже отправлено | 1. Повторить отправку уведомления<br>2. Проверить дедупликацию | - Клиент получил одно уведомление<br>- Дубликаты отфильтрованы<br>- ID уведомления одинаковый |
| 5.4 | Идемпотентность: Повторный возврат средств | Integration | Payment Service | - Возврат уже выполнен | 1. Попытаться выполнить возврат повторно<br>2. Проверить баланс | - Повторный возврат НЕ выполнен<br>- Баланс не изменился<br>- Возвращён статус существующей операции |
| **6. Тесты обработки ошибок и corner cases** |
| 6.1 | Недостаточно средств на счёте клиента | Integration | Payment Service | - Баланс клиента < суммы платежа | 1. Попытаться создать платёж<br>2. Проверить результат | - Платёж отклонён на этапе резервирования<br>- Статус COMPLETED_CANCELLED<br>- Ошибка "Insufficient funds" |
| 6.2 | FraudCheck сервис недоступен (retry) | Integration | Payment Service, FraudCheck Service (mock) | - FraudCheck возвращает 503 | 1. Отправить запрос<br>2. FraudCheck недоступен<br>3. Проверить retry | - Выполнено N попыток retry<br>- Exponential backoff применён<br>- После cut-off → автоматическое одобрение |
| 6.3 | Notification Service недоступен (retry после Pivot) | Integration | Payment Service, Notification Service (mock) | - Платёж успешен<br>- Notification Service недоступен | 1. Перевод контрагенту выполнен<br>2. Notification возвращает ошибку<br>3. Проверить retry | - Retry выполняется многократно<br>- Возврат НЕ инициируется<br>- Процесс не завершается до успешной отправки |
| 6.4 | База данных недоступна | Integration | Payment Service | - PostgreSQL недоступна | 1. Попытаться создать платёж<br>2. Проверить обработку ошибки | - Ошибка корректно обработана<br>- HTTP 503 Service Unavailable<br>- Состояние не повреждено |
| 6.5 | Критическая ошибка: Возврат средств не удался | E2E | Payment Service | - Средства списаны<br>- FraudCheck отклонил<br>- Ошибка в системе возврата | 1. Попытаться выполнить возврат<br>2. Возврат падает с ошибкой<br>3. Проверить эскалацию | - Статус REFUND_FAILED<br>- Финальное состояние MANUAL_INTERVENTION_REQUIRED<br>- Алерт отправлен в службу поддержки<br>- Детали ошибки залогированы |
| 6.6 | Контрагент не существует | Integration | Payment Service | - FraudCheck одобрил<br>- ID контрагента некорректный | 1. Попытаться перевести средства<br>2. Проверить обработку | - Ошибка перед фактическим переводом<br>- Средства возвращены клиенту<br>- Статус COMPLETED_DECLINED |
| 6.7 | Таймаут при переводе контрагенту | Integration | Payment Service | - Сервис перевода медленный/зависает | 1. Перевод занимает > timeout<br>2. Проверить обработку | - Таймаут отработал корректно<br>- Если перевод не подтверждён → возврат<br>- Если перевод выполнен → завершение |
| **7. Тесты производительности и SLA** |
| 7.1 | SLA: Успешный платёж за <5 секунд | Performance | Payment Service, FraudCheck Service, Notification Service | - Все сервисы доступны<br>- Нагрузка нормальная | 1. Выполнить 1000 платежей<br>2. Измерить время каждого | - 90% платежей < 5 секунд<br>- P99 < 10 секунд<br>- Нет ошибок |
| 7.2 | Параллельная обработка множества платежей | Load | Payment Service, FraudCheck Service, Notification Service | - Нагрузочное тестирование<br>- 100 concurrent requests | 1. Отправить 100 платежей одновременно<br>2. Проверить корректность | - Все платежи обработаны корректно<br>- Нет race conditions<br>- Нет дублирования<br>- Нет потерянных транзакций |
| 7.3 | Масштабирование Camunda Engine | Integration | Payment Service (Camunda) | - Множество активных Saga<br>- Высокая нагрузка | 1. Создать 10000 активных Saga<br>2. Измерить производительность | - Camunda обрабатывает нагрузку<br>- Задержки приемлемые<br>- Memory usage стабильный |
| **8. Тесты State Machine** |
| 8.1 | Переходы состояний: Happy Path | Integration | Payment Service | - Платёж создан | 1. Отследить все переходы состояний<br>2. Проверить корректность | - CREATED → FUNDS_RESERVED → FUNDS_DEBITED → FRAUD_CHECK_PENDING → FRAUD_CHECK_APPROVED → COUNTERPARTY_CREDITED → NOTIFICATION_SENT → COMPLETED_SUCCESS |
| 8.2 | Переходы состояний: Declined Path | Integration | Payment Service, FraudCheck Service | - FraudCheck отклоняет | 1. Отследить переходы при отклонении<br>2. Проверить компенсационные переходы | - CREATED → ... → FRAUD_CHECK_DECLINED → SECURITY_NOTIFIED → REFUNDING → REFUNDED → NOTIFICATION_SENT → COMPLETED_DECLINED |
| 8.3 | Переходы состояний: Manual Review Path | Integration | Payment Service, FraudCheck Service | - Manual review требуется | 1. Отследить переходы с ручной проверкой | - ... → FRAUD_CHECK_PENDING → MANUAL_REVIEW_REQUIRED → [decision] → FRAUD_CHECK_APPROVED/DECLINED → ... |
| 8.4 | Невозможные переходы состояний | Integration | Payment Service | - Платёж в определённом состоянии | 1. Попытаться выполнить недопустимый переход<br>2. Проверить валидацию | - Переход отклонён<br>- Ошибка "Invalid state transition"<br>- Состояние не изменилось |
| 8.5 | Восстановление состояния после сбоя | Integration | Payment Service | - Saga в промежуточном состоянии<br>- Сервис перезапущен | 1. Остановить сервис во время Saga<br>2. Перезапустить сервис<br>3. Проверить восстановление | - Camunda восстанавливает состояние<br>- Saga продолжается с того же места<br>- Нет дублирования операций |
| **9. Тесты наблюдаемости и мониторинга** |
| 9.1 | Логирование всех этапов платежа | Integration | Payment Service | - Платёж проходит все этапы | 1. Выполнить платёж<br>2. Проверить логи | - Каждый этап залогирован<br>- Correlation ID присутствует<br>- Timestamps корректны<br>- Log level соответствует важности |
| 9.2 | Метрики успешных платежей | Integration | Payment Service, Prometheus | - Платежи выполняются | 1. Выполнить N платежей<br>2. Проверить метрики | - Счётчик успешных платежей увеличился<br>- Метрика latency обновлена<br>- Метрики доступны в Prometheus |
| 9.3 | Метрики отклонённых платежей | Integration | Payment Service, Prometheus | - Платежи отклоняются | 1. Выполнить отклонённые платежи<br>2. Проверить метрики | - Счётчик declined увеличился<br>- Причины отклонения записаны<br>- Fraud check metrics обновлены |
| 9.4 | Алерты при критических ошибках | Integration | Payment Service, Alert Manager | - Критическая ошибка (возврат не удался) | 1. Симулировать критическую ошибку<br>2. Проверить алерты | - Алерт отправлен немедленно<br>- Severity = CRITICAL<br>- Детали ошибки в алерте<br>- Служба поддержки уведомлена |
| 9.5 | Distributed Tracing с Jaeger | Integration | Payment Service, FraudCheck Service, Notification Service, Jaeger | - Трейсинг настроен | 1. Выполнить платёж<br>2. Найти trace в Jaeger | - Полный trace всех вызовов<br>- Spans для каждого сервиса<br>- Timing каждого этапа<br>- Errors отмечены |
| **10. Тесты безопасности** |
| 10.1 | Аутентификация запросов | Integration | Payment Service | - Запрос без токена | 1. Отправить запрос без JWT<br>2. Проверить ответ | - HTTP 401 Unauthorized<br>- Платёж не создан<br>- Ошибка залогирована |
| 10.2 | Авторизация: Клиент может оплатить только свои заказы | Integration | Payment Service | - Клиент A пытается оплатить заказ клиента B | 1. Отправить запрос с чужим order ID<br>2. Проверить отклонение | - HTTP 403 Forbidden<br>- Платёж не создан<br>- Security event залогирован |
| 10.3 | Injection атаки в параметрах | Integration | Payment Service | - Вредоносные данные в payload | 1. Отправить SQL injection в параметрах<br>2. Проверить защиту | - Запрос отклонён<br>- Валидация сработала<br>- База данных не затронута |
| 10.4 | Rate limiting для предотвращения DDoS | Integration | Payment Service, API Gateway | - Множество запросов от одного клиента | 1. Отправить 100 запросов за 1 секунду<br>2. Проверить throttling | - После N запросов → HTTP 429<br>- Лимит не превышен<br>- Легитимные запросы проходят |
| 10.5 | Шифрование чувствительных данных | Integration | Payment Service, PostgreSQL | - Платёж с чувствительными данными | 1. Создать платёж<br>2. Проверить данные в БД | - Чувствительные поля зашифрованы<br>- Encryption at rest работает<br>- Расшифровка при чтении корректна |

## Итоговая статистика тест-кейсов

- **Всего тест-кейсов**: 52
- **End-to-End тесты**: 7
- **Интеграционные тесты**: 37
- **Performance тесты**: 3
- **Security тесты**: 5

## Покрытие по функциональности

[+] **Основные сценарии** (6 кейсов)
- Happy Path
- FraudCheck Approved/Declined
- Manual Review с одобрением/отклонением
- Cut-off time (2 варианта)

[+] **Интеграция с сервисами** (8 кейсов)
- Payment Service внутренние операции
- FraudCheck Service взаимодействие
- Notification Service взаимодействие
- Security System взаимодействие

[+] **Компенсационные транзакции** (5 кейсов)
- Все типы компенсаций из реестра транзакций
- Полный цикл компенсации

[+] **Pivot Point** (3 кейса)
- Поведение до/после точки невозврата
- Retry после Pivot Point

[+] **Идемпотентность** (4 кейса)
- Повторные запросы для всех критичных операций

[+] **Обработка ошибок** (7 кейсов)
- Corner cases
- Критические ошибки
- Недоступность сервисов
- Таймауты

[+] **Производительность и SLA** (3 кейса)
- Соответствие SLA <5 секунд
- Параллельная обработка
- Масштабирование Camunda

[+] **State Machine** (5 кейсов)
- Все основные пути переходов
- Валидация переходов
- Восстановление после сбоев

[+] **Наблюдаемость** (5 кейсов)
- Логирование
- Метрики
- Алерты
- Distributed Tracing

[+] **Безопасность** (5 кейсов)
- Аутентификация/авторизация
- Защита от атак
- Rate limiting
- Шифрование данных
